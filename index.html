<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GIGA LOTTO: $2.2B Challenge 1.6</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap">
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <style>
    body {
      background: url("https://www.transparenttextures.com/patterns/asfalt-dark.png");
      font-family: 'Press Start 2P', cursive;
      color: #111;
      background-color: #d0d0ff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      background: linear-gradient(#00f, #88f);
      padding: 20px;
      color: white;
      box-shadow: 0 3px 6px rgba(0,0,0,0.3);
      position: relative;
    }
    .header-glow {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
      pointer-events: none;
    }
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: #fffbe8;
      border: 5px double #444;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      position: relative;
      overflow: hidden;
    }
    .container::before {
      content: "";
      position: absolute;
      top: -10px;
      left: -10px;
      right: -10px;
      bottom: -10px;
      border: 2px solid #ff0;
      border-radius: 5px;
      z-index: -1;
      animation: pulse 3s infinite;
    }
    h1 {
      font-size: 1.5em;
      color: #222;
      text-shadow: 0 0 5px rgba(255,255,0,0.7);
    }
    .jackpot-display {
      background: #e0ffe0;
      border: 2px dashed #0a0;
      padding: 15px;
      margin-top: 20px;
      font-size: 1.2em;
      position: relative;
    }
    .progress-bar {
      background: #ccc;
      border: 2px inset #999;
      height: 25px;
      position: relative;
      margin: 10px auto;
      width: 100%;
    }
    .progress-fill {
      height: 100%;
      background: repeating-linear-gradient(45deg, #0f0, #0f0 10px, #afa 10px, #afa 20px);
      width: 0%;
      transition: width 0.5s ease;
    }
    .wallet {
      background: #f0f8ff;
      border: 2px solid #00c;
      padding: 10px;
      margin-top: 20px;
    }
    .user-dashboard {
      background: #eef;
      padding: 10px;
      margin-top: 20px;
      border: 2px solid #009;
    }
    .actions {
      margin: 20px 0;
    }
    button {
      background: #00c;
      color: #fff;
      font-size: 1em;
      border: 2px solid #000;
      padding: 10px 20px;
      cursor: pointer;
      box-shadow: 2px 2px #888;
      margin: 5px;
      font-family: 'Press Start 2P', cursive;
      transition: all 0.2s;
    }
    button:hover {
      background: #00f;
      transform: translateY(-2px);
      box-shadow: 3px 3px #666;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 1px 1px #aaa;
    }
    #withdrawBtn {
      background: linear-gradient(#0f0, #080);
    }
    #requestDrawBtn {
      background: linear-gradient(#f90, #f60);
    }
    footer {
      font-size: 0.6em;
      margin: 30px auto;
      color: #444;
    }
    #status {
      background: #ffd;
      padding: 15px;
      margin: 20px 0;
      border: 2px solid #aa0;
      font-size: 0.9em;
    }
    input {
      padding: 10px;
      font-family: 'Press Start 2P', cursive;
      border: 2px inset #999;
      margin: 10px;
      width: 200px;
    }
    .winner-banner {
      background: linear-gradient(90deg, #ff0, #f90, #ff0);
      padding: 10px;
      margin: 10px 0;
      border: 3px solid #f90;
      animation: shine 2s infinite;
    }
    @keyframes shine {
      0% { box-shadow: 0 0 5px #ff0; }
      50% { box-shadow: 0 0 20px #ff0; }
      100% { box-shadow: 0 0 5px #ff0; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px rgba(255,255,0,0.5); }
      50% { box-shadow: 0 0 20px rgba(255,255,0,0.8); }
      100% { box-shadow: 0 0 5px rgba(255,255,0,0.5); }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-glow"></div>
    <h1>ü§ë GIGA LOTTO - $2.2B CHALLENGE ü§ë</h1>
    <p>The lottery that only draws when crypto makes history</p>
  </header>
  <div class="container">
    <div class="jackpot-display">
      <strong>üí∞ Jackpot Pool:</strong> <span id="jackpot">Loading...</span><br>
      <strong>üéØ Target:</strong> $2.2B USD<br>
      <strong>üìà Holding Above Target For:</strong> <span id="holdTimer">--:--:--</span>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    <div class="jackpot-display">
      <strong>üî• USD Deposited Last 24h:</strong> <span id="usd24h">Loading...</span> USD
    </div>
    <div class="wallet">
      <p><strong>üéüÔ∏è Enter the Pot</strong></p>
      <input type="number" id="ethAmount" placeholder="Amount in ETH" step="0.001" />
      <!-- FIXED: Changed to ID instead of onclick -->
      <button id="depositBtn">Connect & Deposit</button>
    </div>
    <div class="user-dashboard" id="userDashboard" style="display:none;">
      <p><strong>Connected:</strong> <span id="userAddress"></span></p>
      <p><strong>Your Total Deposits:</strong> <span id="userDeposit">0</span> ETH</p>
    </div>
    <div class="actions">
      <button id="withdrawBtn" style="display:none;">Withdraw Winnings</button>
      <button id="requestDrawBtn" style="display:none;">Request Draw</button>
    </div>
    <div id="status"></div>
  </div>
  <footer>
    <p>Contract verified | Non-custodial | Transparent rules | Community driven</p>
    <p>&copy; 2025 GIGA LOTTO Project</p>
  </footer>

  <script>
    let web3;
    let contract;
    let userAccount;
    const contractAddress = "0xF5aEA51f7fAaABe16Fd3c14Da9Fa90e223D41404";
    const abi = [
      {
        "inputs": [],
        "name": "deposit",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "_priceFeed",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "_vrfCoordinator",
            "type": "address"
          },
          {
            "internalType": "bytes32",
            "name": "_keyHash",
            "type": "bytes32"
          },
          {
            "internalType": "uint256",
            "name": "_subscriptionId",
            "type": "uint256"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "have",
            "type": "address"
          },
          {
            "internalType": "address",
            "name": "want",
            "type": "address"
          }
        ],
        "name": "OnlyCoordinatorCanFulfill",
        "type": "error"
      },
      {
        "anonymous": false,
        "inputs": [
          {
            "indexed": true,
            "internalType": "address",
            "name": "previousOwner",
            "type": "address"
          },
          {
            "indexed": true,
            "internalType": "address",
            "name": "newOwner",
            "type": "address"
          }
        ],
        "name": "OwnershipTransferred",
        "type": "event"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "requestId",
            "type": "uint256"
          },
          {
            "internalType": "uint256[]",
            "name": "randomWords",
            "type": "uint256[]"
          }
        ],
        "name": "rawFulfillRandomWords",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "renounceOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "requestDraw",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "newOwner",
            "type": "address"
          }
        ],
        "name": "transferOwnership",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "withdrawFees",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "withdrawIfWinner",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "stateMutability": "payable",
        "type": "receive"
      },
      {
        "inputs": [],
        "name": "callbackGasLimit",
        "outputs": [
          {
            "internalType": "uint32",
            "name": "",
            "type": "uint32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "canDraw",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "collectedFees",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "entries",
        "outputs": [
          {
            "internalType": "address",
            "name": "user",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "cumulativeWeight",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "FEE_PERCENT",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getEntriesCount",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "index",
            "type": "uint256"
          }
        ],
        "name": "getEntry",
        "outputs": [
          {
            "internalType": "address",
            "name": "user",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "cumulative",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getJackpotUsd",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "holdStartTimestamp",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "keyHash",
        "outputs": [
          {
            "internalType": "bytes32",
            "name": "",
            "type": "bytes32"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "last24hDepositUsd",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "last24hWindowStart",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "lastRequestId",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "MIN_24H_USD",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "owner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "priceFeed",
        "outputs": [
          {
            "internalType": "contract AggregatorV2V3Interface",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "requestConfirmations",
        "outputs": [
          {
            "internalType": "uint16",
            "name": "",
            "type": "uint16"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "subscriptionId",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "TARGET_USD",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "totalPool",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "userDeposits",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "vrfCoordinator",
        "outputs": [
          {
            "internalType": "contract VRFCoordinatorV2Interface",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "winner",
        "outputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    // Initialize Web3 and contract
    async function initWeb3() {
      if (window.ethereum) {
        try {
          web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(abi, contractAddress);
          
          // REMOVED automatic account request here
          startUpdates();
          
        } catch (error) {
          console.error("Error initializing Web3:", error);
          document.getElementById("status").innerHTML = "‚ö†Ô∏è Error initializing Web3. See console for details.";
        }
      } else {
        document.getElementById("status").innerHTML = "‚ö†Ô∏è Please install MetaMask or another Web3 provider!";
      }
    }

    // NEW FUNCTION: Connect wallet only when requested
    async function connectWallet() {
      if (!web3 || !contract) {
        await initWeb3();
        if (!web3 || !contract) return;
      }
      
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        
        // Set up account change listener
        window.ethereum.on('accountsChanged', (accounts) => {
          userAccount = accounts[0];
          updateUI();
        });
        
        updateUI();
        
      } catch (error) {
        console.error("Wallet connection failed:", error);
        document.getElementById("status").innerHTML = "‚ö†Ô∏è Wallet connection failed. Please try again.";
      }
    }

    // MODIFIED: Now combines wallet connection and deposit
    async function connectAndDeposit() {
      // Connect wallet first if not connected
      if (!userAccount) {
        await connectWallet();
        if (!userAccount) return; // Stop if connection failed
      }
      
      // Now process deposit
      const ethAmount = document.getElementById("ethAmount").value;
      if (!ethAmount || parseFloat(ethAmount) <= 0) {
        document.getElementById("status").innerHTML = "‚ö†Ô∏è Please enter a valid ETH amount";
        return;
      }
      
      try {
        const valueInWei = web3.utils.toWei(ethAmount, "ether");
        document.getElementById("status").innerHTML = "‚è≥ Processing deposit...";
        
        await contract.methods.deposit().send({ 
          from: userAccount, 
          value: valueInWei 
        });
        
        document.getElementById("status").innerHTML = "‚úÖ Deposit successful!";
        updateUI();
      } catch (error) {
        console.error("Deposit failed:", error);
        document.getElementById("status").innerHTML = `‚ö†Ô∏è Deposit failed: ${error.message}`;
      }
    }

    // ... rest of existing functions (updateUI, updateHoldTimer, etc.) ...

    // MODIFIED: Update UI to handle disconnected state
    async function updateUI() {
      try {
        // Always update public jackpot info
        const totalPool = await contract.methods.totalPool().call();
        const jackpotUsd = await contract.methods.getJackpotUsd().call();
        document.getElementById("jackpot").innerHTML = 
          `<strong>${web3.utils.fromWei(totalPool, "ether")} ETH</strong> ($${(jackpotUsd / 1e8).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})})`;
        
        // Update progress bar
        const targetUsd = await contract.methods.TARGET_USD().call();
        const percent = (jackpotUsd / targetUsd) * 100;
        document.getElementById("progressFill").style.width = `${Math.min(percent, 100)}%`;
        
        // Update 24h deposits
        const last24hUsd = await contract.methods.last24hDepositUsd().call();
        document.getElementById("usd24h").innerText = `$${(last24hUsd / 1e8).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})`;
        
        // Update hold timer
        updateHoldTimer();
        
        // Only show user dashboard if connected
        if (userAccount) {
          document.getElementById("userAddress").innerText = 
            `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
          document.getElementById("userDashboard").style.display = "block";
          
          const userDeposit = await contract.methods.userDeposits(userAccount).call();
          document.getElementById("userDeposit").innerText = 
            web3.utils.fromWei(userDeposit, "ether");
        } else {
          document.getElementById("userDashboard").style.display = "none";
        }
        
        // ... rest of winner/draw status checks ...

      } catch (error) {
        console.error("Error updating UI:", error);
        // Don't show full error to user, just generic message
        document.getElementById("status").innerHTML = `‚ö†Ô∏è Error updating data.`;
      }
    }

    // Initialize when page loads
    window.addEventListener('load', async () => {
      await initWeb3(); // Initialize without connecting wallet
      
      // Set up event listeners
      document.getElementById("depositBtn").addEventListener('click', connectAndDeposit);
      document.getElementById("withdrawBtn").addEventListener('click', withdrawWinnings);
      document.getElementById("requestDrawBtn").addEventListener('click', requestDraw);
    });
  </script>
</body>
</html>
